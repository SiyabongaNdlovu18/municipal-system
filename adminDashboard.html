<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="center-screen">

<div class="card glass">
  <h2>Welcome Admin: <span id="adminName"></span></h2>
  <table id="issuesTable"></table>
</div>

<script>
document.getElementById("adminName").innerText = sessionStorage.getItem("username");

async function loadIssues(){
  const res = await fetch('/issues');
  const issues = await res.json();
  const workers = await (await fetch('/workers')).json();

  let html = `<tr>
      <th>ID</th><th>Citizen</th><th>Issue</th><th>Description</th>
      <th>Location</th><th>Assigned Worker</th><th>Status</th><th>Assign</th><th>Action</th>
  </tr>`;

  issues.forEach(i=>{
    html += `<tr>
      <td>${i.id}</td>
      <td>${i.citizen_name}</td>
      <td>${i.issue_type}</td>
      <td>${i.description}</td>
      <td>${i.location}</td>
      <td>${i.assigned_worker ?? 'Unassigned'}</td>
      <td>${i.status}</td>
      <td>
        <select onchange="assignWorker(${i.id}, this.value)">
          <option>Select Worker</option>
          ${workers.map(w=>`<option value="${w.username}">${w.username}</option>`).join('')}

        </select>
      </td>
      <td>
        <button onclick="deleteIssue(${i.id})">Delete</button>
      </td>
    </tr>`;
  });

  document.getElementById("issuesTable").innerHTML = html;
}

async function assignWorker(id, worker){
  await fetch(`/assign/${id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({worker})
  });
  alert("Worker Assigned!");
  loadIssues();
}

async function deleteIssue(id){
  if(confirm("Are you sure?")){
    await fetch(`/deleteIssue/${id}`, { method:"DELETE" });
    alert("Deleted!");
    loadIssues();
  }
}

loadIssues();
</script>

</body>
</html>
